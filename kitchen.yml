---
driver:
  name: ec2
  aws_ssh_key_id: chef-testing
  region: us-east-1
  availability_zone: us-east-1a
  require_chef_omnibus: true
  instance_type: t3.small
  associate_public_ip: true
  interface: dns
  # Global timeout settings (can be overridden per platform)
  retryable_tries: 60      # Default wait time for instances
  retryable_sleep: 5       # Default check interval
  tags:
    Project: 'chef-cookbook-testing'
    Cookbook: 'root-password-rotation'
    CreatedBy: 'test-kitchen'

provisioner:
  name: chef_infra
  install_strategy: always
  policyfile: Policyfile.rb
  chef_license: accept-silent

verifier:
  name: inspec

platforms:
  # Modern Linux Platforms
  - name: ubuntu-22.04
    driver:
      image_id: ami-0e2c8caa4b6378d8c  # Ubuntu 22.04 LTS (us-east-1)
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      username: ubuntu
      ssh_key: ~/.ssh/chef-testing.pem
      connection_timeout: 10
      connection_retries: 5
      connection_retry_sleep: 5
      keepalive: true
      keepalive_interval: 60

  - name: amazonlinux-2023
    driver:
      image_id: ami-0c101f26f147fa7fd  # Amazon Linux 2023 (us-east-1)
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      username: ec2-user
      ssh_key: ~/.ssh/chef-testing.pem
      connection_timeout: 10
      connection_retries: 5
      connection_retry_sleep: 5
      keepalive: true
      keepalive_interval: 60

  # Windows Server 2022
  # Note: Windows testing currently encounters a kitchen-ec2 bug where it fails with
  # "no implicit conversion of nil into String" after password retrieval.
  # This is a known issue with kitchen-ec2 3.19.0. The cookbook itself works correctly
  # on Windows, but automated Test Kitchen testing requires manual verification.
  - name: windows-2022
    driver:
      image_id: ami-0159172a5a821bafd
      subnet_id: subnet-0614cbb61b0a4ea78
      instance_type: t3.medium
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      name: winrm

suites:
  - name: password-rotation
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/password-rotation
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'TestKitchenPassword123!'
        rotate_password: true

  - name: user-rename
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/user-rename
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'TestKitchenPassword123!'
        rotate_password: true
        linux:
          username: 'root'
          new_username: 'sysadmin'
          rename_home_dir: true
        windows:
          username: 'Administrator'
          new_username: 'WinAdmin'
          rename_home_dir: true
          update_profile_path: true

  - name: password-only
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/password-only
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'NewPassword456!'
        rotate_password: true

  - name: rename-only
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/rename-only
    attributes:
      root_password_rotation:
        rotate_password: false
        linux:
          username: 'root'
          new_username: 'adminuser'
          rename_home_dir: false
        windows:
          username: 'Administrator'
          new_username: 'AdminUser'
          rename_home_dir: false
