---
driver:
  name: ec2
  aws_ssh_key_id: chef-testing
  region: us-east-1
  availability_zone: us-east-1a
  require_chef_omnibus: true
  instance_type: t3.small
  associate_public_ip: true
  interface: dns
  # Global timeout settings (can be overridden per platform)
  retryable_tries: 60      # Default wait time for instances
  retryable_sleep: 5       # Default check interval
  tags:
    Project: 'chef-cookbook-testing'
    Cookbook: 'root-password-rotation'
    CreatedBy: 'test-kitchen'

provisioner:
  name: chef_infra
  install_strategy: always
  policyfile: Policyfile.rb
  chef_license: accept-silent

verifier:
  name: inspec

platforms:
  # Modern Linux Platforms
  - name: ubuntu-22.04
    driver:
      image_id: ami-0e2c8caa4b6378d8c  # Ubuntu 22.04 LTS (us-east-1)
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      username: ubuntu
      ssh_key: ~/.ssh/chef-testing.pem
      connection_timeout: 10
      connection_retries: 5
      connection_retry_sleep: 5
      keepalive: true
      keepalive_interval: 60

  - name: amazonlinux-2023
    driver:
      image_id: ami-0c101f26f147fa7fd  # Amazon Linux 2023 (us-east-1)
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      username: ec2-user
      ssh_key: ~/.ssh/chef-testing.pem
      connection_timeout: 10
      connection_retries: 5
      connection_retry_sleep: 5
      keepalive: true
      keepalive_interval: 60

  # Windows Server 2022
  # KNOWN ISSUE: kitchen-ec2 3.19.0-3.21.0 has a bug causing "no implicit conversion 
  # of nil into String" error after Windows password retrieval. This prevents automated
  # Test Kitchen testing on Windows. The cookbook recipes work correctly on Windows
  # when deployed manually. For manual testing:
  #   1. Create a Windows EC2 instance manually
  #   2. Bootstrap with Chef: knife bootstrap windows winrm IPADDRESS -x Administrator -P PASSWORD
  #   3. Upload cookbook: knife cookbook upload root-password-rotation
  #   4. Run chef-client on the Windows node
  - name: windows-2022
    driver:
      image_search:
        owner-id: '801119661308'
        name: Windows_Server-2022-English-Full-Base*
      instance_type: t3.medium
      retryable_tries: 120
      retryable_sleep: 10
    transport:
      name: winrm
      username: <%= ENV['KITCHEN_WINDOWS_USER'] || 'Administrator' %>
      elevated: true

suites:
  - name: password-rotation
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/password-rotation
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'TestKitchenPassword123!'
        rotate_password: true

  - name: user-rename
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/user-rename
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'TestKitchenPassword123!'
        rotate_password: true
        linux:
          username: 'root'
          new_username: 'sysadmin'
          rename_home_dir: true
        windows:
          username: 'Administrator'
          new_username: 'WinAdmin'
          rename_home_dir: true
          update_profile_path: true

  - name: password-only
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/password-only
    attributes:
      root_password_rotation:
        password_source: 'attribute'
        password: 'NewPassword456!'
        rotate_password: true

  - name: rename-only
    provisioner:
      policyfile: Policyfile.rb
    verifier:
      inspec_tests:
        - test/integration/rename-only
    attributes:
      root_password_rotation:
        rotate_password: false
        linux:
          username: 'root'
          new_username: 'adminuser'
          rename_home_dir: false
        windows:
          username: 'Administrator'
          new_username: 'AdminUser'
          rename_home_dir: false
